---
- hosts: localhost
  tasks:
    - name: Test create Site IPSec VPN connection (ikeV1)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        name: "Test Site IPSec VPN Connection"
        speed: 50
        high_availability: true
        location_href: "{{ location_href }}"
        billing_term: HOURLY
        primary_customer_router_ip: 192.167.1.1
        secondary_customer_router_ip: 192.167.1.2
        customer_asn: 1231
        ike_version: V1
        ike_encryption: AES_256
        ike_integrity: SHA512_HMAC
        ike_dh_group: MODP_2048
        esp_encryption: AES_256_GCM_128
        esp_dh_group: MODP_2048
        customer_networks:
          - address: 192.167.1.1/32
            name: My Custom Address
        nat_enabled: true
        nat_mappings:
          - 192.167.1.1/32
        enable_bgp_password: true
      register: result
    - debug: var=result
    - fail:
      when: result.changed != true

    - name: Test update Site IPSec VPN connection (ikeV1) (no changes)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        id: "{{ result.connection.id }}"
        name: "{{ result.connection.name }}"
        speed: "{{ result.connection.speed }}"
        high_availability: "{{ result.connection.highAvailability }}"
        location_href: "{{ location_href }}"
        billing_term: "{{ result.connection.billingTerm }}"
        primary_customer_router_ip: "{{ result.connection.primaryCustomerRouterIP }}"
        secondary_customer_router_ip: "{{ result.connection.secondaryCustomerRouterIP }}"
        customer_asn: "{{ result.connection.customerASN }}"
        ike_version: "{{ result.connection.ikeVersion }}"
        ike_encryption: "{{ result.connection.ikeV1.ike.encryption }}"
        ike_integrity: "{{ result.connection.ikeV1.ike.integrity }}"
        ike_dh_group: "{{ result.connection.ikeV1.ike.dhGroup }}"
        esp_encryption: "{{ result.connection.ikeV1.esp.encryption }}"
        esp_dh_group: "{{ result.connection.ikeV1.esp.dhGroup }}"
        customer_networks: "{{ result.connection.customerNetworks }}"
        nat_enabled: "{{ result.connection.nat.enabled }}"
        nat_mappings: "{{ result.connection.nat.mappings | json_query('[*].nativeCidr') }}"
        enable_bgp_password: "{{ result.connection.enableBGPPassword }}"
      register: result
    - debug: var=result
    - fail:
      when: result.changed == true

    - name: Test update Site IPSec VPN connection (ikeV1) (changes)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        id: "{{ result.connection.id }}"
        name: "{{ result.connection.name }}"
        speed: 100
        high_availability: "{{ result.connection.highAvailability }}"
        location_href: "{{ location_href }}"
        billing_term: "{{ result.connection.billingTerm }}"
        primary_customer_router_ip: "{{ result.connection.primaryCustomerRouterIP }}"
        secondary_customer_router_ip: "{{ result.connection.secondaryCustomerRouterIP }}"
        customer_asn: "{{ result.connection.customerASN }}"
        ike_version: "{{ result.connection.ikeVersion }}"
        ike_encryption: "{{ result.connection.ikeV1.ike.encryption }}"
        ike_integrity: "{{ result.connection.ikeV1.ike.integrity }}"
        ike_dh_group: "{{ result.connection.ikeV1.ike.dhGroup }}"
        esp_encryption: "{{ result.connection.ikeV1.esp.encryption }}"
        esp_dh_group: "{{ result.connection.ikeV1.esp.dhGroup }}"
        customer_networks: "{{ result.connection.customerNetworks }}"
        nat_enabled: "{{ result.connection.nat.enabled }}"
        nat_mappings: "{{ result.connection.nat.mappings | json_query('[*].nativeCidr') }}"
        enable_bgp_password: "{{ result.connection.enableBGPPassword }}"
      register: result
    - debug: var=result
    - fail:
      when: result.changed != true

    - name: Test delete Site IPSec VPN connection (ikeV1)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        state: 'absent'
        id: "{{ result.connection.id }}"
        name: "{{ result.connection.name }}"
        speed: "{{ result.connection.speed }}"
        high_availability: "{{ result.connection.highAvailability }}"
        location_href: "{{ location_href }}"
        billing_term: "{{ result.connection.billingTerm }}"
        primary_customer_router_ip: "{{ result.connection.primaryCustomerRouterIP }}"
        secondary_customer_router_ip: "{{ result.connection.secondaryCustomerRouterIP }}"
        customer_asn: "{{ result.connection.customerASN }}"
        ike_version: "{{ result.connection.ikeVersion }}"
        ike_encryption: "{{ result.connection.ikeV1.ike.encryption }}"
        ike_integrity: "{{ result.connection.ikeV1.ike.integrity }}"
        ike_dh_group: "{{ result.connection.ikeV1.ike.dhGroup }}"
        esp_encryption: "{{ result.connection.ikeV1.esp.encryption }}"
        esp_dh_group: "{{ result.connection.ikeV1.esp.dhGroup }}"
        customer_networks: "{{ result.connection.customerNetworks }}"
        nat_enabled: "{{ result.connection.nat.enabled }}"
        nat_mappings: "{{ result.connection.nat.mappings | json_query('[*].nativeCidr') }}"
        enable_bgp_password: "{{ result.connection.enableBGPPassword }}"
      register: result
    - debug: var=result
    - fail:
      when: result.changed != true

    - name: Test create Site IPSec VPN connection (ikeV2)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        name: "Test Site IPSec VPN Connection"
        speed: 50
        high_availability: true
        location_href: "{{ location_href }}"
        billing_term: HOURLY
        primary_customer_router_ip: 192.167.1.1
        secondary_customer_router_ip: 192.167.1.2
        customer_asn: 1231
        ike_version: V2
        ike_encryption: AES_128_GCM_64
        ike_prf: SHA_512
        ike_dh_group: MODP_2048
        esp_encryption: AES_256_GCM_128
        esp_dh_group: MODP_2048
        customer_networks:
          - address: 192.167.1.1/32
            name: My Custom Address
        nat_enabled: true
        nat_mappings:
          - 192.167.1.1/32
        enable_bgp_password: true
      register: result
    - debug: var=result
    - fail:
      when: result.changed != true

    - name: Test update Site IPSec VPN connection (ikeV2) (no changes)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        id: "{{ result.connection.id }}"
        name: "{{ result.connection.name }}"
        speed: "{{ result.connection.speed }}"
        high_availability: "{{ result.connection.highAvailability }}"
        location_href: "{{ location_href }}"
        billing_term: "{{ result.connection.billingTerm }}"
        primary_customer_router_ip: "{{ result.connection.primaryCustomerRouterIP }}"
        secondary_customer_router_ip: "{{ result.connection.secondaryCustomerRouterIP }}"
        customer_asn: "{{ result.connection.customerASN }}"
        ike_version: "{{ result.connection.ikeVersion }}"
        ike_encryption: "{{ result.connection.ikeV2.ike.encryption }}"
        ike_prf: "{{ result.connection.ikeV2.ike.prf }}"
        ike_dh_group: "{{ result.connection.ikeV2.ike.dhGroup }}"
        esp_encryption: "{{ result.connection.ikeV2.esp.encryption }}"
        esp_dh_group: "{{ result.connection.ikeV2.esp.dhGroup }}"
        customer_networks: "{{ result.connection.customerNetworks }}"
        nat_enabled: "{{ result.connection.nat.enabled }}"
        nat_mappings: "{{ result.connection.nat.mappings | json_query('[*].nativeCidr') }}"
        enable_bgp_password: "{{ result.connection.enableBGPPassword }}"
      register: result
    - debug: var=result
    - fail:
      when: result.changed == true

    - name: Test update Site IPSec VPN connection (ikeV2) (changes)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        id: "{{ result.connection.id }}"
        name: "{{ result.connection.name }}"
        speed: 100
        high_availability: "{{ result.connection.highAvailability }}"
        location_href: "{{ location_href }}"
        billing_term: "{{ result.connection.billingTerm }}"
        primary_customer_router_ip: "{{ result.connection.primaryCustomerRouterIP }}"
        secondary_customer_router_ip: "{{ result.connection.secondaryCustomerRouterIP }}"
        customer_asn: "{{ result.connection.customerASN }}"
        ike_version: "{{ result.connection.ikeVersion }}"
        ike_encryption: "{{ result.connection.ikeV2.ike.encryption }}"
        ike_prf: "{{ result.connection.ikeV2.ike.prf }}"
        ike_dh_group: "{{ result.connection.ikeV2.ike.dhGroup }}"
        esp_encryption: "{{ result.connection.ikeV2.esp.encryption }}"
        esp_dh_group: "{{ result.connection.ikeV2.esp.dhGroup }}"
        customer_networks: "{{ result.connection.customerNetworks }}"
        nat_enabled: "{{ result.connection.nat.enabled }}"
        nat_mappings: "{{ result.connection.nat.mappings | json_query('[*].nativeCidr') }}"
        enable_bgp_password: "{{ result.connection.enableBGPPassword }}"
      register: result
    - debug: var=result
    - fail:
      when: result.changed != true

    - name: Test delete Site IPSec VPN connection (ikeV2)
      pureport_site_ipsec_vpn_connection:
        api_base_url: "{{ api_base_url }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret }}"
        network_href: "{{ network_href }}"
        wait_for_server: true
        state: 'absent'
        id: "{{ result.connection.id }}"
        name: "{{ result.connection.name }}"
        speed: "{{ result.connection.speed }}"
        high_availability: "{{ result.connection.highAvailability }}"
        location_href: "{{ location_href }}"
        billing_term: "{{ result.connection.billingTerm }}"
        primary_customer_router_ip: "{{ result.connection.primaryCustomerRouterIP }}"
        secondary_customer_router_ip: "{{ result.connection.secondaryCustomerRouterIP }}"
        customer_asn: "{{ result.connection.customerASN }}"
        ike_version: "{{ result.connection.ikeVersion }}"
        ike_encryption: "{{ result.connection.ikeV2.ike.encryption }}"
        ike_prf: "{{ result.connection.ikeV2.ike.prf }}"
        ike_dh_group: "{{ result.connection.ikeV2.ike.dhGroup }}"
        esp_encryption: "{{ result.connection.ikeV2.esp.encryption }}"
        esp_dh_group: "{{ result.connection.ikeV2.esp.dhGroup }}"
        customer_networks: "{{ result.connection.customerNetworks }}"
        nat_enabled: "{{ result.connection.nat.enabled }}"
        nat_mappings: "{{ result.connection.nat.mappings | json_query('[*].nativeCidr') }}"
        enable_bgp_password: "{{ result.connection.enableBGPPassword }}"
      register: result
    - debug: var=result
    - fail:
      when: result.changed != true
